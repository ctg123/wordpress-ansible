# WordPress Installation
---
- hosts: servers
  gather_facts: True 
  become: yes

  # Defining the environment variables.
  vars: 
   wp_mysql_db: wordpress
   wp_mysql_user: wp-admin
   wp_mysql_password: admin123
   wp_mysql_host: "{{ansible_default_ipv4.address}}"

  pre_tasks:
    - name: Update apt cache if needed.
      apt: update_cache=yes cache_valid_time=3600

  handlers:
    - name: restart apache
      service: name=apache2 state=restarted


  # Tasks to execute during the installation process.
  tasks:
    - name: Get software for apt repository management.
      apt:
        state: present
        name:
         - python3-apt
         - python3-pycurl

    - name: Add ondrej repository for later versions of PHP.
      apt_repository: repo='ppa:ondrej/php' update_cache=yes

    - name: "Install Apache, MySQL, PHP, and other dependencies."
      apt:
        state: present
        name:
         - acl
         - git
         - curl
         - unzip
         - sendmail
         - apache2
         - php7.4-common
         - php7.4-cli
         - php7.4-dev
         - php7.4-gd
         - php7.4-curl
         - php7.4-json
         - php7.4-opcache
         - php7.4-xml
         - php7.4-mbstring
         - php7.4-pdo
         - php7.4-mysql
         - php-apcu
         - libpcre3-dev
         - libapache2-mod-php7.4
         - python3-mysqldb
         - python-mysqldb
         - mysql-server
         - mysql-client 

    - name: Disable the firewall (for local dev only).
      service: name=ufw state=stopped

    - name: "Start Apache, MySQL, and PHP."
      service: "name={{ item }} state=started enabled=yes"
      with_items:
        - apache2
        - mysql

    - name: Remove the default Apache2 welcome page from the webserver(s).
      file: 
        path: "/var/www/html/index.html"
        state: absent

    - name: Downloading WordPress to document root of remote nodes
      unarchive:
         src: http://www.wordpress.org/latest.tar.gz
         dest: /var/www/html/
         remote_src: yes

    - name: Update default Apache Site
      lineinfile:
        path: /etc/apache2/sites-enabled/000-default.conf
        state: present
        regexp: '(.)+DocumentRoot /var/www/html'
        line: 'DocumentRoot /var/www/wordpress'

    - name: Restart Apache
      service: 
        name: apache2
        state: restarted

    - name: Renaming the Sample WordPress configuration for the webserver. 
      command: "mv /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php"

    - name: Adjust OpCache memory setting.
      lineinfile:
         dest: "/etc/php/7.4/apache2/conf.d/10-opcache.ini"
         regexp: "^opcache.memory_consumption"
         line: "opcache.memory_consumption = 96"
         state: present
      notify: restart apache

    - name: Update WordPress config file
      lineinfile: dest=/var/www/html/wordpress/wp-config.php regexp={{ item.regexp }} line={{ item.line }}
      with_items:
       - {'regexp': "define\\( 'DB_NAME', '(database_name_here)+' \\);", 'line': "define('DB_NAME', '{{wp_mysql_db}}');"}
       - {'regexp': "define\\( 'DB_USER', '(username_here)+' \\);", 'line': "define('DB_USER', '{{wp_mysql_user}}');"}
       - {'regexp': "define\\( 'DB_PASSWORD', '(password_here)+' \\);", 'line': "define('DB_PASSWORD', '{{wp_mysql_password}}');"}
       - {'regexp': "define\\( 'DB_HOST', '(localhost)+' \\);", 'line': "define('DB_HOST', '{{wp_mysql_host}}');"}

    #- name: Update default Apache site
    #  lineinfile:
    #    dest=/var/www/html/index.html
    #    line="DocumentRoot /var/www/html/wordpress"

    - name: Starting the MySQL service
      service:
        name: mysql
        state: started

    - name: Creating database for WordPress
      mysql_db:
        name: "{{wp_mysql_db}}"
        state: present

    - name: Creating user for WordPress and allow all permissions to db wordpress
      mysql_user:
        name: "{{wp_mysql_user}}"
        password: "{{wp_mysql_password}}"
        host: '%'
        priv: '*.*:ALL'
        state: present

    - name: Starting apache2 and mysqld
      service: name={{ item }} state=restarted
      with_items:
       - apache2
       - mysql
